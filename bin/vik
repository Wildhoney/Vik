#!/usr/bin/env node
"use strict";
process.title = 'vik';

if (!process.argv[2]) {
    msg('Forgot to specify major/minor/patch', 198);
}

var grunt   = require('grunt'),
    exec    = require('child_process').exec,
    sys     = require('sys'),
    clc     = require('cli-color'),
    file    = grunt.file.readJSON('package.json'),
    version = file.version,
    which   = process.argv[2].trim();

var msg = function msg(message, colour, backgroundColour) {
    var msg = clc.xterm(colour).bgXterm(backgroundColour);
    console.log(msg('  ' + message + '  '));
};


// Parse the version major.minor.patch.
var parsed  = version.match(/(\d+)\.(\d+)\.(\d+)/),
    major   = parseInt(parsed[1]),
    minor   = parseInt(parsed[2]),
    patch   = parseInt(parsed[3]);

switch (which) {
    case ('major'): major++; minor = 0; patch = 0; break;
    case ('minor'): minor++; patch = 0; break;
    case ('patch'): patch++; break;
}

// Update the version with the updated value, and then execute
// the `npm version` command.
version = major + '.' + minor + '.' + patch;
exec('npm version ' + version, function(error, stdout, stderr) {

    var notClean      = new RegExp('Git working directory not clean', 'i'),
        alreadyExists = new RegExp('already exists', 'i');

    if (stderr.match(notClean)) {
        msg('Git working directory is not clean.', 88, 218);
        return;
    }

    if (stderr.match(alreadyExists)) {
        msg('Tag ' + version + ' already exists.', 88, 218);
        return;
    }

    msg('Updated version to ' + version, 22, 122);

});